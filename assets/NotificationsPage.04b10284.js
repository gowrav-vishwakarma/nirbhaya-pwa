import{z as te,A as G,I as J,r as _,B as oe,v as pe,w as j,D as m,R as k,S as r,T as a,$ as H,X as g,ay as he,Y as V,u as se,bn as ne,V as v,al as z,bv as ae,bt as ie,E as A,ar as re,at as K,au as ce,a0 as P,W as X,ap as Z,a3 as le,G as ue,F,af as de,aj as me,aM as fe,bm as ve,as as _e,U as W,o as ye,aI as $e}from"./index.168e4218.js";import{u as we}from"./use-form.7267c9e0.js";import{u as ge}from"./useBackgroundNotifications.732cae92.js";import{socket as T}from"./socket.04092846.js";import{$ as Ie}from"./bundler.c7d5908c.js";const ke=te({__name:"NotificationAudioControl",props:{sosEventId:{}},emits:["audio-closed"],setup(ee,{emit:U}){const E=ee,N=U,C=G(),{t:$}=J(),n=_(null),y=_(""),c=_(null),p=_(!1),i=_(null),w=_(!1),b=_(null),L=()=>{T.on("sos_audio_started",M),T.on("sos_audio_stopped",t),T.on("peers_in_room",Q)},O=()=>{T.off("sos_audio_started",M),T.off("sos_audio_stopped",t),T.off("peers_in_room",Q)};oe(async()=>{console.log("NotificationAudioControl mounted for eventId:",E.sosEventId);try{await f()}catch(e){console.error("Error during peer initialization on mount:",e)}}),pe(()=>{I(),s()});const x=()=>{n.value||(y.value="vol_"+T.id,n.value=new Ie(y.value),n.value.on("open",e=>{console.log("Volunteer peer ID is:",e)}),n.value.on("call",e=>{e.answer(),e.on("stream",o=>{console.log("Received stream from SOS peer"),B(e.peer,o)})}),n.value.on("error",e=>{console.error("PeerJS error:",e),setTimeout(x,5e3)}))},R=()=>{!n.value||T.emit("join_sos_room",{peerId:y.value,sosEventId:E.sosEventId,isSos:!1})},Q=e=>{console.log("Peers in room:",e);const o=e.find(u=>u.startsWith("sos_"));o&&(i.value=o)},B=(e,o)=>{c.value||(c.value=new Audio),c.value.srcObject=o,c.value.muted=!p.value,c.value.play().catch(u=>{console.error("Error playing audio:",u)})};j(()=>E.sosEventId,()=>{s(),p.value=!1,x()});const l=async()=>{try{w.value=!0,p.value?I():(await f(),R(),L(),p.value=!0,c.value&&(c.value.muted=!1,c.value.play().catch(e=>{console.error("Error playing audio:",e)})))}catch(e){console.error("Error toggling audio:",e),C.notify({color:"negative",message:$("common.errorTogglingAudio"),icon:"warning",position:"top-right"}),p.value=!1}finally{w.value=!1}},I=()=>{p.value=!1,c.value&&(c.value.muted=!0,c.value.pause()),O(),T.emit("leave_sos_room",{peerId:y.value,sosEventId:E.sosEventId}),N("audio-closed")},f=async()=>{n.value||(x(),await new Promise((e,o)=>{const u=setTimeout(()=>{o(new Error("Peer initialization timed out"))},2e4),d=()=>{n.value&&n.value.id?(clearTimeout(u),e()):n.value?setTimeout(d,100):(clearTimeout(u),o(new Error("Peer initialization failed")))};d()}))},M=e=>{b.value=e,C.notify({message:$("common.sosAudioStarted"),color:"info",position:"top-right"})},t=()=>{b.value=null,C.notify({message:$("common.sosAudioStopped"),color:"warning",position:"top-right"}),c.value&&(c.value.pause(),c.value.srcObject=null)},s=()=>{var e,o;(e=n.value)==null||e.disconnect(),(o=n.value)==null||o.destroy(),n.value=null,c.value&&(c.value.pause(),c.value.srcObject=null)};return(e,o)=>(m(),k(V,{round:"",color:p.value?"primary":"grey",icon:e.$t("common.icons.volumeUp"),onClick:l,loading:w.value,disable:w.value},{default:r(()=>[a(he,null,{default:r(()=>[H(g(e.$t(p.value?"muteAudio":"unmuteAudio")),1)]),_:1})]),_:1},8,["color","icon","loading","disable"]))}});const be={class:"notifications-content"},Se={class:"text-h5 text-weight-bold q-mb-md"},Ae={class:"notification-header"},Ne={class:"notification-title"},Te={class:"notification-time"},Ee={class:"notification-threat"},Ce={class:"text-center q-mt-md"},xe={key:1,class:"no-notifications",style:{"text-align":"center"}},Me={class:"text-h6 text-grey-6"},qe=te({__name:"NotificationsHistoryPage",emits:["notifications-updated"],setup(ee,{emit:U}){const E=se(),N=G(),{unreadNotificationCount:C}=ge(),$=_([]),n=_(!1),y=_(10),c=_(0),p=_(!1),i=_(!0),w=async(l=!1)=>{l||(n.value=!0);try{const f=(await F.post("/global/contact-sos-events",{userId:E.user.id,limit:y.value,offset:c.value})).data||[];l?$.value=[...$.value,...f]:$.value=f,i.value=f.length===y.value}catch(I){console.error("Error fetching notifications:",I),N.notify({type:"negative",message:b("common.errorLoadingMore"),position:"top-right"})}finally{n.value=!1}},{t:b}=J(),L=ne();oe(async()=>{await w()}),j(C,async()=>{c.value=0,await w()}),j(()=>L.query.key,async()=>{c.value=0,await w()});const O=l=>{const I=l.threat||"SOS";return b("common.notificationTitles.emergencyContact",{eventType:b(`${I}`),victimName:l.user.name})},x=l=>{switch(l){case"resolved":return"green";default:return"grey"}},R=l=>{const I=new Date,f=new Date(l),M=Math.floor((I.getTime()-f.getTime())/1e3),t=new Intl.DateTimeFormat(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}).format(f);let s;if(M<60)s="justNow";else{const e=Math.floor(M/60);if(e<60)s=`${e} minutes Ago`;else{const o=Math.floor(e/60);if(o<24){const u=e%60;s=`${o} hours And ${u} minutes Ago`}else{const u=Math.floor(o/24);if(u<30){const d=o%24;s=`${u} days And ${d} hours Ago`}else{const d=Math.floor(u/30);if(d<12)s=`${d} ${d===1?"month Ago":"months Ago"}`;else{const S=Math.floor(u/365);s=`${S} ${S===1?"year Ago":"years Ago"}`}}}}}return`${s}
${t}`},Q=l=>l.status==="resolved"?"check_circle":"warning",B=async()=>{if(!p.value){p.value=!0,c.value+=y.value;try{await w(!0)}finally{p.value=!1}}};return(l,I)=>(m(),k(le,{class:"notifications-page q-pa-md"},{default:r(()=>[v("div",be,[a(Z,{class:"notifications-card q-mb-md",style:{margin:"10px 20px"}},{default:r(()=>[a(z,null,{default:r(()=>[v("div",Se,g(l.$t("common.notifications")),1),a(ae,{showing:n.value},{default:r(()=>[a(ie,{size:"50px",color:"primary"})]),_:1},8,["showing"]),n.value?P("",!0):(m(),A(K,{key:0},[$.value.length>0?(m(),k(re,{key:0,class:"q-mb-md"},{default:r(()=>[(m(!0),A(K,null,ce($.value,f=>(m(),k(de,{key:f.id,class:"q-py-md q-ma-none notification-item"},{default:r(()=>[a(me,null,{default:r(()=>[a(Z,{flat:"",bordered:"",class:"notification-card"},{default:r(()=>[a(z,null,{default:r(()=>[v("div",Ae,[a(X,{name:Q(f),size:"24px",class:"notification-icon"},null,8,["name"]),v("span",Ne,g(O(f)),1),a(fe),a(ve,{color:x(f.status),"text-color":"white",size:"sm"},{default:r(()=>[H(g(l.$t(`common.sosStatus.${f.status}`)),1)]),_:2},1032,["color"])]),v("div",Te,g(R(f.createdAt)),1)]),_:2},1024),a(z,{class:"q-pa-none"},{default:r(()=>[v("div",Ee,[H(g(l.$t("common.threat"))+": ",1),v("strong",null,g(l.$t(f.threat||"Emergency Alert")),1)])]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128)),v("div",Ce,[i.value?(m(),k(V,{key:0,color:"primary",loading:p.value,onClick:B,label:"Load more"},null,8,["loading"])):P("",!0)])]),_:1})):(m(),A("div",xe,[v("div",Me,[a(X,{name:"notifications_off",size:"48px",color:"grey-6"}),v("div",null,g(l.$t("common.noNotificationsFound")),1)])]))],64))]),_:1})]),_:1})])]),_:1}))}});var De=ue(qe,[["__scopeId","data-v-19d45832"]]);const Pe={class:"notifications-content"},Qe={class:"text-right"},ze={key:0},Le={key:1},Oe={class:"text-h5 text-weight-bold q-mb-md"},Re={class:"notification-header"},Be={class:"notification-title"},Fe={class:"notification-time"},Ve={key:0,class:"notification-threat"},je={key:1,class:"notification-location"},He={key:1,class:"no-notifications",style:{"text-align":"center"}},Ue={class:"text-h6 text-grey-6"},Ye=te({__name:"NotificationsPage",emits:["notifications-updated"],setup(ee,{emit:U}){const E=se(),N=G(),{unreadNotificationCount:C,fetchUnreadNotificationCount:$}=ge(),{responseData:n,validateAndSubmit:y,callbacks:c,isLoading:p}=we(F,"/notifications",{},"get");c.onSuccess=()=>{console.log("Notification accepted")};const{t:i}=J(),w=ne(),b=_(!1);oe(async()=>{await y(!1)}),j(C,async()=>{await y(!1)}),j(()=>w.query.key,async()=>{await y(!1)});const L=t=>{var e;const s=((e=t.sosEvent)==null?void 0:e.threat)||"SOS";return t.recipientType==="volunteer"?i("common.notificationTitles.volunteerNearby",{eventType:i(`${s}`)}):t.recipientType==="emergency_contact"?i(t.sosEvent.contactsOnly?"common.notificationTitles.contactsOnly":"common.notificationTitles.emergencyContact",{eventType:i(`${s}`),victimName:t.userLocationName}):""},O=t=>{switch(t){case"active":return"red";case"sent":return"red";case"received":return"red";case"accepted":return"red";case"ignored":return"red";default:return"grey"}},x=async t=>{try{await F.post(`/notifications/${t}/accept`);const s=n.value.findIndex(e=>e.id===t);s!==-1&&(n.value[s].status="accepted"),N.notify({color:"black",message:i("common.notificationAcceptedSuccess"),icon:"check",position:"top-right"}),await $()}catch(s){console.error("Error accepting notification:",s),N.notify({color:"negative",message:i("common.notificationAcceptedError"),icon:"error",position:"top-right"})}},R=t=>{if(t&&t.coordinates){const[s,e]=t.coordinates,o=`https://www.google.com/maps/dir/?api=1&destination=${e},${s}`;window.open(o,"_blank")}else N.notify({color:"negative",message:i("common.locationNotAvailable"),icon:"error",position:"top-right"})},Q=t=>t<1e3?`${Math.round(t)} ${i("meters")}`:`${(t/1e3).toFixed(2)} ${i("kilometers")}`,B=t=>{const s=new Date,e=new Date(t),o=Math.floor((s.getTime()-e.getTime())/1e3),u=new Intl.DateTimeFormat(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}).format(e);let d;if(o<60)d=i("common.justNow");else{const S=Math.floor(o/60);if(S<60)d=`${S} ${i("minutes Ago")}`;else{const q=Math.floor(S/60);if(q<24){const h=S%60;d=`${q} ${i("hours And")} ${h} ${i("minutes Ago")}`}else{const h=Math.floor(q/24);if(h<30){const D=q%24;d=`${h} ${i("days And")} ${D} ${i("hours Ago")}`}else{const D=Math.floor(h/30);if(D<12)d=`${D} ${i(D===1?"common.monthAgo":"common.monthsAgo")}`;else{const Y=Math.floor(h/365);d=`${Y} ${i(Y===1?"common.yearAgo":"common.yearsAgo")}`}}}}}return`${d}
${u}`},l=async t=>{try{await F.post(`/notifications/${t}/discard`),n.value=n.value.filter(s=>s.id!==t),N.notify({color:"black",message:i("common.notificationDiscardedSuccess"),icon:"check",position:"top-right"})}catch(s){console.error("Error discarding notification:",s),N.notify({color:"negative",message:i("common.notificationDiscardedError"),icon:"error",position:"top-right"})}};(async(t=2e4)=>{const s=G(),{t:e}=J();if(console.log("call current notification count"),!E.isLoggedIn)return;const o=async()=>{try{const d=n.value.map(h=>h.eventId).filter(Boolean);if(!d.length)return;const S=await F.post("/sos/current-event-list",{data:{eventId:d}});C.value=S.data.length;const q=S.data.filter(h=>h.status==="resolved"||h.status==="cancelled");q.length>0&&(q.forEach(h=>{n.value=n.value.filter(Y=>Y.eventId!==h.id);const D=h.status==="cancelled"?"common.notificationCancelled":"common.notificationResolved";s.notify({color:"black",message:e(D,{eventId:h.id}),icon:"check",position:"top-right",timeout:1e4,actions:[{label:"Dismiss",color:"white"}]})}),M("notifications-updated",n.value))}catch(d){console.error("Error fetching unread notification count:",d)}};await o();const u=setInterval(o,t);ye(()=>{u&&clearInterval(u)})})();const f=t=>t.status==="accepted"?"check_circle":"warning",M=U;return(t,s)=>(m(),k(le,{class:"notifications-page q-pa-md"},{default:r(()=>[v("div",Pe,[v("div",Qe,[a(_e,{modelValue:b.value,"onUpdate:modelValue":s[0]||(s[0]=e=>b.value=e),label:"Show Old Notifications",style:{margin:"0px 20px"},color:"black",class:"text-weight-bold text-white","left-label":""},null,8,["modelValue"])]),b.value?(m(),A("div",ze,[a(De)])):(m(),A("div",Le,[a(Z,{class:"notifications-card q-mb-md",style:{margin:"10px 20px"}},{default:r(()=>[a(z,null,{default:r(()=>[v("div",Oe,g(t.$t("common.notifications")),1),a(ae,{showing:W(p)},{default:r(()=>[a(ie,{size:"50px",color:"primary"})]),_:1},8,["showing"]),W(p)?P("",!0):(m(),A(K,{key:0},[W(n).length>0?(m(),k(re,{key:0,separator:""},{default:r(()=>[(m(!0),A(K,null,ce(W(n),e=>(m(),k(de,{key:e.id,class:"q-py-md q-ma-none notification-item"},{default:r(()=>[a(me,null,{default:r(()=>[a(Z,{flat:"",bordered:"",class:"notification-card"},{default:r(()=>[a(z,null,{default:r(()=>{var o;return[v("div",Re,[a(X,{name:f(e),size:"24px",class:"notification-icon"},null,8,["name"]),v("span",Be,g(L(e)),1),a(fe),a(ve,{color:O((o=e.sosEvent)==null?void 0:o.status),"text-color":"white",size:"sm"},{default:r(()=>{var u;return[H(g(t.$t(`common.sosStatus.${(u=e.sosEvent)==null?void 0:u.status}`)),1)]}),_:2},1032,["color"])]),v("div",Fe,g(B(e.sosEvent.createdAt)),1)]}),_:2},1024),a(z,{class:"q-pa-none"},{default:r(()=>{var o;return[(o=e.sosEvent)!=null&&o.threat?(m(),A("div",Ve,[H(g(t.$t("common.threat"))+": ",1),v("strong",null,g(t.$t(e.sosEvent.threat)),1)])):P("",!0),e.userLocationName&&e.distanceToEvent?(m(),A("div",je,g(Q(e.distanceToEvent))+" "+g(t.$t("common.awayFrom"))+" "+g(e.userLocationName),1)):P("",!0)]}),_:2},1024),a($e,{align:"right",class:"q-gutter-sm"},{default:r(()=>[e.status==="sent"?(m(),k(V,{key:0,color:"primary",label:t.$t("common.accept"),onClick:o=>x(e.id),dense:"","no-caps":""},null,8,["label","onClick"])):e.status==="accepted"?(m(),k(V,{key:1,color:"secondary",label:t.$t("common.follow"),onClick:o=>R(e.sosEvent.location),dense:"","no-caps":""},null,8,["label","onClick"])):P("",!0),e.status==="accepted"?(m(),k(ke,{key:2,"sos-event-id":e.sosEvent.id},null,8,["sos-event-id"])):P("",!0),a(V,{color:"negative",label:t.$t("common.discard"),onClick:o=>l(e.id),flat:"",dense:"","no-caps":""},null,8,["label","onClick"])]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})):(m(),A("div",He,[v("div",Ue,[a(X,{name:"notifications_off",size:"48px",color:"grey-6"}),v("div",null,g(t.$t("common.noNotificationsFound")),1)])]))],64))]),_:1})]),_:1})]))])]),_:1}))}});var Ze=ue(Ye,[["__scopeId","data-v-30c55b91"]]);export{Ze as default};
