import{y as ao,_ as so,z as Ce,A as Ee,I as Ae,u as Ne,r as a,e as te,B as Re,v as Fe,a0 as ae,G as no,H as lo,bn as ro,bo as io,C as ke,bp as co,aA as uo,N as Ie,bq as mo,F as vo,br as po,bs as go,D as $,R as Pe,S as n,E as B,T as t,bt as fo,al as $e,V as i,X as u,bu as ho,Y as V,W as b,ay as ce,$ as N,ar as yo,af as oe,aj as Q,ai as O,at as Te,au as So,U as qe,ap as _o,a1 as bo,aD as wo,a3 as xo,az as Oo}from"./index.168e4218.js";import{u as ko}from"./use-user-form.aba52028.js";import{socket as y}from"./socket.04092846.js";import{$ as Io}from"./bundler.c7d5908c.js";import"./use-form.7267c9e0.js";ao("Network",{web:()=>so(()=>import("./web.9b0f5d1b.js"),["assets/web.9b0f5d1b.js","assets/index.168e4218.js","assets/index.85b279a3.css"]).then(W=>new W.NetworkWeb)});const Po=Ce({__name:"SosAudioControls",props:{sosEventId:{}},emits:["audioStatusChange"],setup(W,{emit:Y}){const T=W,R=Y,p=Ee(),{t:F}=Ae();Ne();const c=a(null),f=a("");a(!0),a(null),a(!1);const w=a(null),h=te(()=>!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)),S=()=>{y.on("sos_audio_started",x),y.on("sos_audio_stopped",C),y.on("peers_in_room",g)},j=()=>{y.off("sos_audio_started",x),y.off("sos_audio_stopped",C),y.off("peers_in_room",g)};Re(async()=>{try{await q(),se(),S(),v(),k("success")}catch(l){console.error("Error during peer initialization on mount:",l),k("error")}}),Fe(()=>{U(),j(),y.connected?(console.log("Leaving SOS room"),y.emit("leave_sos_room",{peerId:f.value,sosEventId:T.sosEventId})):console.warn("Socket disconnected before leaving SOS room")});const H=()=>{c.value||(f.value="sos_"+y.id,c.value=new Io(f.value),c.value.on("open",l=>{console.log("SOS peer ID is:",l)}),c.value.on("call",l=>{l.answer()}),c.value.on("error",l=>{console.error("PeerJS error:",l),setTimeout(H,5e3)}))},se=()=>{!c.value||y.emit("join_sos_room",{peerId:f.value,sosEventId:T.sosEventId,isSos:!0})},g=l=>{console.log("Peers in room:",l),l.forEach(d=>{d.startsWith("vol_")&&L(d)})},L=async l=>{if(!!c.value)try{const d=await navigator.mediaDevices.getUserMedia({audio:!0}),D=c.value.call(l,d)}catch(d){console.error("Error calling peer:",d)}},v=async()=>{var l;if(!h.value){console.error("Navigator media not supported"),k("error");return}try{const d=await navigator.mediaDevices.getUserMedia({audio:!0});(l=c.value)==null||l.call("volunteer_peer_id",d),k("success")}catch(d){console.error("Error starting audio broadcast:",d),k("error")}},q=async()=>{c.value||(H(),await new Promise((l,d)=>{const D=setTimeout(()=>{d(new Error("Peer initialization timed out"))},2e4),_=()=>{c.value&&c.value.id?(clearTimeout(D),l()):c.value?setTimeout(_,100):(clearTimeout(D),d(new Error("Peer initialization failed")))};_()}))},x=l=>{w.value=l,p.notify({message:F("common.sosAudioStarted"),color:"info",position:"top-right"})},C=()=>{w.value=null,p.notify({message:F("common.sosAudioStopped"),color:"warning",position:"top-right"})},U=()=>{var l,d;(l=c.value)==null||l.disconnect(),(d=c.value)==null||d.destroy(),c.value=null},k=l=>{R("audioStatusChange",l)};return(l,d)=>ae("",!0)}});const $o={key:0,class:"loader-overlay"},To={class:"text-h5 text-weight-bold text-center q-mb-md"},qo={key:0,class:"text-center q-mb-lg"},Co={class:"text-h5"},Eo={class:"text-subtitle1 q-mt-sm"},Ao={class:"text-bold"},No={class:"text-center q-mb-lg"},Ro={class:"text-h6 text-red text-weight-bold q-mt-sm"},Fo={class:"status-icons q-mb-md",style:{display:"flex","justify-content":"center","align-items":"center","background-color":"antiquewhite","border-radius":"20px",width:"200px",margin:"auto",padding:"3px","margin-bottom":"20px","margin-top":"10px"}},Lo={key:0,class:"q-ma-none",style:{"margin-top":"-10px","text-align":"center"}},Uo={class:"q-mb-sm"},Do={class:"",style:{"font-size":"20px","font-weight":"bolder",color:"whitesmoke",margin:"0",padding:"0"}},Mo={style:{"margin-top":"-30px"}},zo={class:"",style:{"font-size":"20px","font-weight":"bolder",color:"whitesmoke",margin:"0",padding:"0"}},Bo={style:{"margin-top":"-30px"}},Vo={class:"",style:{"font-size":"18px","font-weight":"bolder",color:"whitesmoke",margin:"0",padding:"0"}},Qo={style:{"margin-top":"-30px"}},Wo={class:"text-weight-bold q-mb-sm",style:{"font-size":"16px"}},Yo={class:"q-col-gutter-sm q-mb-md"},jo={class:"flex",style:{width:"100%"}},Ho={class:"q-ml-xs",style:{"font-weight":"bold"}},Ko={class:"text-subtitle1 text-weight-bold q-mb-sm"},Go={class:"text-bold"},ue=10,Jo=Ce({__name:"SOSModeOnPage",setup(W){const Y=lo(),T=ro(),{t:R}=Ae(),p=Ee(),F=Ne(),c=a(!1),f=a(!1),w=a(ue);let h=null;const S=a(!1),j=a(!1),H=a(0),se=a(0),g=a(T.query.sosEventId?parseInt(String(T.query.sosEventId)):0),L=a(T.query.contactsOnly==="true"),v=a({latitude:null,longitude:null}),q=a("");let x=null;const C=a(!1),U=a(!1),{permissions:k,checkPermissions:l,requestPermission:d,activatePermission:D}=io(),_=te(()=>F.user.streamAudioVideoOnSos),Le=a(null),K=te(()=>F.user.startAudioVideoRecordOnSos),de=a(!1),Ue=[{color:"#000000",icon:"emergency",threatName:"domesticViolence",visibleThreat:"common.domesticViolence"},{color:"#FF0000",icon:"diversity_3",threatName:"attemptedKidnapping",visibleThreat:"common.attemptedKidnapping"},{color:"#808000",icon:"touch_app",threatName:"physicalThreat",visibleThreat:"common.physicalThreat"},{color:"#641e16",icon:"pan_tool",threatName:"sexualAssault",visibleThreat:"common.sexualAssault"},{color:"#FF00FF",icon:"gesture",threatName:"followedBySomeone",visibleThreat:"common.followedBySomeone"},{color:"#008080",icon:"record_voice_over",threatName:"verbalHarassment",visibleThreat:"common.verbalHarassment"}],De=a([]),m=e=>{De.value.push(e)},me=a([5e3,1e4,2e4,3e4]),ne=a(0),Me=a(0),M=a(null),G=a([]),J=a([]),ve=a(0),pe=a(!1),z=a(null),X=a(null);a([]);const Z=a("pending"),ee=a("pending"),E=a("pending"),I=te(()=>{const e=ke.getPlatform()==="ios";return{extension:e?"mp4":"webm",mimeType:e?"video/mp4":"video/webm;codecs=vp8,opus"}}),le=e=>{switch(e){case"success":return"green";case"error":return"red";case"pending":return"grey";default:return"grey"}},re=(e,o)=>{switch(e){case"success":return`${o} is working properly`;case"error":return`Error with ${o}`;case"pending":return`Initializing ${o}`;default:return`Unknown ${o} status`}};Re(async()=>{await l(),await Ve(),fe(),await he(),(K.value||_.value)&&await Ge(),(K.value||_.value)&&(ee.value="pending")});const ge=()=>new Promise(e=>{j.value=!0,console.log("showResolveConfirmation");const o=de.value?"Your location has been sent to the server.":"Your location has not been sent to the server yet.";p.dialog({title:"SOS Event Options",message:`What would you like to do with your SOS event? ${o}`,options:{type:"radio",model:"close",items:[{label:"Cancel the SOS event",value:"cancel"},{label:"Resolve the SOS event",value:"resolve"},{label:"Keep the SOS event active",value:"keep"}]},cancel:!0,persistent:!0}).onOk(async s=>{switch(s){case"cancel":await A({status:"cancelled"}),p.notify({message:"Your SOS event has been closed.",color:"info",position:"top-right",timeout:3e3}),S.value=!1,Y.push("/sos"),e(!0);break;case"resolve":await A({status:"resolved"}),p.notify({message:"Your SOS event has been resolved.",color:"positive",position:"top-right",timeout:3e3}),S.value=!1,e(!0);break;case"keep":p.notify({message:"Your SOS event remains active.",color:"warning",position:"top-right",timeout:3e3}),e(!1);break}}).onCancel(()=>{p.notify({message:"Action cancelled. Your SOS event remains active.",color:"warning",position:"top-right"}),e(!1)}).onDismiss(()=>{j.value=!1})});co(async(e,o,s)=>{console.log("Leaving SOSModeOnPage"),c.value=!0,h&&clearInterval(h),await je(),await we(),S.value?await ge()?s():s(!1):s(),c.value=!1}),Fe(async()=>{console.log("Unmounting SOSModeOnPage"),await we()});const fe=()=>{h&&clearInterval(h),w.value=ue,h=setInterval(()=>{w.value--,w.value<=0&&(clearInterval(h),A({status:"active",confirm:!0}))},1e3)},ze=()=>{fe()},Be=async()=>{try{m("SOS request cancelled."),Y.push("/sos")}catch(e){m("Failed to cancel SOS request: "+e)}},Ve=async()=>{const e=["common.location","common.camera"];for(const o of e){const s=k.value.find(r=>r.name===o);s&&!s.granted&&(await d(o),m(`${o} permission granted.`)),await D(o)}},A=async e=>{try{(e.confirm||!S.value)&&(h&&clearInterval(h),S.value=!0,H.value=10,se.value=3),v.value.latitude&&v.value.longitude&&(P.value.location={latitude:v.value.latitude,longitude:v.value.longitude},de.value=!0),e.status&&(P.value.status=e.status),e.threat&&(P.value.threat=e.threat),P.value.contactsOnly=L.value,P.value.sosEventId=g.value,(e.status==="resolved"||e.status==="cancelled")&&(c.value=!0),await ye(),e.status==="resolved"&&p.dialog({component:uo,componentProps:{eventId:g.value,source:"sosmode"}}),console.log("SOS data updated:",P.value),m("SOS data updated: "+JSON.stringify({location:v.value,status:e.status,threat:e.threat,contactsOnly:L.value,sosEventId:g.value},null,2)),U.value||He()}catch(o){c.value=!1,m("Failed to update SOS data: "+o),console.error("Failed to update SOS data:",o)}},Qe=e=>{A({threat:e,status:"active",confirm:!0})},he=async()=>{try{E.value="pending",x=await Ie.watchPosition({enableHighAccuracy:!0,timeout:3e4,maximumAge:1e4},We),m("Started watching location"),console.log("Started watching location")}catch(e){m("Error starting location watch: "+e),console.error("Error starting location watch:",e),q.value=R("common.locationWatchError"),E.value="error"}},We=(e,o)=>{var s,r;if(o){m("Error in location update: "+o),console.error("Error in location update:",o),E.value="error",q.value=R("common.locationError");return}if(e){const ie={latitude:e.coords.latitude,longitude:e.coords.longitude};v.value=ie,q.value=`Lat: ${(s=ie.latitude)==null?void 0:s.toFixed(4)}, Lon: ${(r=ie.longitude)==null?void 0:r.toFixed(4)}`,U.value=!0,E.value="success",Ye()}},Ye=mo(()=>{const e=Date.now();S.value&&(e-ve.value>1e4||pe.value)&&(A({}).catch(console.error),m("Location updated and sent to server"),ve.value=e,pe.value=!1)},1e4),je=async()=>{x!==null&&(await Ie.clearWatch({id:x}),x=null,console.log("Stopped watching location"))},{values:P,validateAndSubmit:ye,errors:Xo,callbacks:Se,isLoading:Zo,updateUrl:et}=ko("sos/sos-update",{location:"",status:"",threat:"",contactsOnly:L.value,sosEventId:g.value,updateNearbyAlso:!1});Se.beforeSubmit=e=>(e.updateNearbyAlso=f.value,f.value&&(e.status=e.status?e.status:"active",e.contactsOnly=!1),e);const _e=a(0),be=a(0);Se.onSuccess=e=>(console.log("data...........",e),_e.value=e.informed,be.value=e.accepted,g.value=parseInt(e.sosEventId),Le.value=e.presignedUrl,e);const He=async()=>{x||await he(),U.value&&await A({location:v.value,status:"active"})},Ke=e=>{const o=[I.value.mimeType,...e];for(const s of o)if(MediaRecorder.isTypeSupported(s))return m("Supported MIME type found: "+s),s;return null},Ge=async()=>{try{if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){X.value=await navigator.mediaDevices.getUserMedia({video:{width:640,height:480},audio:!0});const e=Ke(["video/webm;codecs=vp8,opus","video/webm;codecs=vp9,opus","video/webm;codecs=h264,opus","video/mp4;codecs=h264,aac","video/mp4;codecs=h265,aac","video/mp4;codecs=avc1,aac","video/webm","video/mp4","video/x-matroska","video/quicktime"]);if(!e)throw new Error("No supported mime type found for video recording");const o={mimeType:e,videoBitsPerSecond:25e4,audioBitsPerSecond:128e3};z.value=new MediaRecorder(X.value,o),z.value.ondataavailable=Je,z.value.start(5e3),C.value=!0,Me.value=Date.now(),Z.value="success",_.value&&xe()}else throw new Error("Media Devices API not available")}catch(e){console.error("Failed to start recording:",e),m("Failed to start recording: "+e),Z.value="error"}},we=async()=>{z.value&&C.value&&(z.value.stop(),C.value=!1,X.value&&X.value.getTracks().forEach(e=>e.stop()),M.value&&clearTimeout(M.value),_.value&&await Oe(),K.value&&await Ze())},xe=()=>{const e=me.value[ne.value];M.value&&clearTimeout(M.value),M.value=setTimeout(()=>{Oe(),ne.value<me.value.length-1&&ne.value++,xe()},e)},Je=e=>{e.data.size>0&&(_.value&&G.value.push(e.data),K.value&&J.value.push(e.data))},Oe=async()=>{if(G.value.length>0&&_.value){const e=new Blob(G.value,{type:I.value.mimeType}),o=`video_${Date.now()}.${I.value.extension}`;await Xe(e,o),G.value=[]}},Xe=async(e,o)=>{try{const{data:s}=await vo.get("/sos/get-presigned-url",{params:{sosEventId:g.value,fileName:o,contentType:I.value.mimeType}});await fetch(s.presignedUrl,{method:"PUT",body:e,headers:{"Content-Type":I.value.mimeType}}),console.log(`Uploaded ${o} successfully`),m(`Uploaded ${o} successfully`)}catch(s){console.error("Failed to upload video:",s),m("Failed to upload video: "+s)}},Ze=async()=>{if(J.value.length>0){const e=new Blob(J.value,{type:I.value.mimeType}),o=`sos_recording_${g.value}.${I.value.extension}`;if(ke.isNativePlatform()){const s=await eo(e);try{const r=await po.writeFile({path:`DCIM/Nirbhaya/${o}`,data:s,directory:go.ExternalStorage,recursive:!0});console.log("File saved:",r.uri),m(`Full recording saved to DCIM/Nirbhaya/${o}`),p.notify({message:`Video saved as ${o}`,color:"positive",icon:"save",position:"top",timeout:3e3})}catch(r){console.error("Failed to save full recording:",r),m("Failed to save full recording: "+r),p.notify({message:"Failed to save video. Please check app permissions.",color:"negative",icon:"error",position:"top-right",timeout:3e3})}}else{const s=URL.createObjectURL(e),r=document.createElement("a");r.style.display="none",r.href=s,r.download=o,document.body.appendChild(r),r.click(),URL.revokeObjectURL(s),document.body.removeChild(r),m("Full recording downloaded in browser: "+o)}J.value=[]}},eo=e=>new Promise((o,s)=>{const r=new FileReader;r.onloadend=()=>o(r.result),r.onerror=s,r.readAsDataURL(e)}),oo=e=>{ee.value=e},to=()=>{f.value=!0,P.value.updateNearbyAlso=f.value,ye(),p.notify({message:"SOS Sent Nearby Volunteers.",color:"positive",position:"top-right",timeout:2e3})};return(e,o)=>($(),Pe(xo,{class:bo(["sos-page q-pa-md",{"platform-ios":qe(wo).is.ios}])},{default:n(()=>[c.value?($(),B("div",$o,[t(fo,{color:"white",size:"60",class:"q-mb-md"})])):ae("",!0),t(_o,{class:"sos-card q-pa-lg"},{default:n(()=>[t($e,null,{default:n(()=>[i("div",To,u(e.$t("common.sosMode")),1),S.value?($(),B(Te,{key:1},[i("div",No,[t(b,{name:"warning",color:"red",size:"4rem",style:{"margin-top":"-10px"}}),i("div",Ro,u(e.$t("common.sosSent")),1),i("div",Fo,[t(b,{name:e.$t("common.icons.videocam"),color:le(Z.value),size:"sm"},{default:n(()=>[t(ce,null,{default:n(()=>[N(u(re(Z.value,"recording")),1)]),_:1})]),_:1},8,["name","color"]),t(b,{name:e.$t("common.icons.mic"),color:le(ee.value),size:"sm",class:"q-ml-sm"},{default:n(()=>[t(ce,null,{default:n(()=>[N(u(re(ee.value,"audio")),1)]),_:1})]),_:1},8,["name","color"]),t(b,{name:e.$t("common.icons.locationOn"),color:le(E.value),size:"sm",class:"q-ml-sm"},{default:n(()=>[t(ce,null,{default:n(()=>[N(u(re(E.value,"location")),1)]),_:1})]),_:1},8,["name","color"])]),t(Po,{sosEventId:g.value,onAudioStatusChange:oo},null,8,["sosEventId"])]),f.value?ae("",!0):($(),B("div",Lo,[i("div",Uo,[t(V,{onClick:to,round:"",style:{height:"60px",width:"60px",color:"white","background-color":"orange","border-radius":"50%"}},{default:n(()=>o[0]||(o[0]=[i("span",{style:{"font-weight":"900","padding-top":"15px","font-size":"18px"}},[N(" Sos "),i("p",{style:{"font-size":"9px","margin-top":"-8px","font-weight":"800"},class:"text-capitalize"}," Nearby ")],-1)])),_:1})]),o[1]||(o[1]=i("span",{class:"q-ma-none",style:{"font-weight":"700"}},"Send SOS to nearby volunteers?",-1))])),t(yo,{bordered:"",class:"rounded-borders notify-person-box q-mb-md q-mt-none flex justify-evenly",style:{border:"1px solid pink","margin-top":"10px"}},{default:n(()=>[t(oe,null,{default:n(()=>[t(Q,{style:{"text-align":"center"}},{default:n(()=>[t(O,null,{default:n(()=>[i("span",Do,u(_e.value),1)]),_:1}),t(O,{class:"q-px-sm notify-person-box-label"},{default:n(()=>[t(b,{name:"person"}),i("span",Mo,u(e.$t("common.notifiedPersons")),1)]),_:1})]),_:1})]),_:1}),t(oe,null,{default:n(()=>[t(Q,{style:{"text-align":"center"}},{default:n(()=>[t(O,null,{default:n(()=>[i("span",zo,u(be.value),1)]),_:1}),t(O,{class:"q-px-sm notify-person-box-label"},{default:n(()=>[t(b,{name:"person"}),i("span",Bo,u(e.$t("common.acceptedPersons")),1)]),_:1})]),_:1})]),_:1}),t(oe,null,{default:n(()=>[t(Q,{style:{"text-align":"center"}},{default:n(()=>[t(O,null,{default:n(()=>[i("span",Vo,u(e.$t("common.yes")),1)]),_:1}),t(O,{class:"q-px-sm notify-person-box-label"},{default:n(()=>[i("span",Qo,u(e.$t("common.emergencyContactsInformed")),1),t(b,{name:"done_all",color:"blue"})]),_:1})]),_:1})]),_:1})]),_:1})],64)):($(),B("div",qo,[t(ho,{"show-value":"",class:"text-red q-ma-md",value:w.value,size:"150px",thickness:.22,color:"red","track-color":"grey-3",min:0,max:ue,onClick:ze},{default:n(()=>[i("div",Co,u(w.value),1)]),_:1},8,["value"]),i("div",Eo,u(e.$t("common.sosCountdownMessage")),1),t(V,{onClick:Be,class:"cancel-sos-button full-width q-py-sm"},{default:n(()=>[i("span",Ao,u(e.$t("common.cancelSOS")),1)]),_:1})])),i("div",Wo,u(e.$t("common.helpUsMore")),1),i("div",Yo,[i("div",jo,[($(),B(Te,null,So(Ue,s=>t(V,{key:s.threatName,class:"button-background q-mr-xs",onClick:r=>Qe(s.threatName),size:"sm",style:{"border-radius":"30px"}},{default:n(()=>[t(V,{round:"",size:"sm",style:Oo({marginLeft:"-10px",backgroundColor:`${s.color}`,borderRadius:"50%"})},{default:n(()=>[t(b,{name:s.icon,style:{color:"whitesmoke"}},null,8,["name"])]),_:2},1032,["style"]),i("span",Ho,u(e.$t(s.visibleThreat)),1)]),_:2},1032,["onClick"])),64))])]),i("div",Ko,u(e.$t("common.currentLocation")),1),t(oe,{class:"bg-grey-2 rounded-borders q-mb-md"},{default:n(()=>[t(Q,{avatar:""},{default:n(()=>[t(b,{name:e.$t("common.icons.myLocation"),color:"primary"},null,8,["name"])]),_:1}),t(Q,null,{default:n(()=>[t(O,null,{default:n(()=>[N(u(q.value||e.$t("common.gettingLocation")),1)]),_:1}),v.value.latitude!=null&&v.value.longitude!=null?($(),Pe(O,{key:0,caption:""},{default:n(()=>[N(u(qe(R)("common.coordinates"))+": "+u(v.value.latitude.toFixed(6))+", "+u(v.value.longitude.toFixed(6)),1)]),_:1})):ae("",!0)]),_:1})]),_:1}),t(V,{onClick:ge,color:"",class:"green-bg-color full-width q-mt-md"},{default:n(()=>[i("span",Go,u(e.$t("common.resolveSOSIssue")),1)]),_:1})]),_:1}),t($e)]),_:1})]),_:1},8,["class"]))}});var lt=no(Jo,[["__scopeId","data-v-148c009a"]]);export{lt as default};
